<code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Author:&nbsp;Orange&nbsp;Tsai(@orange_8361)&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">include&nbsp;</span><span style="color: #DD0000">"config.php"</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;foreach(</span><span style="color: #0000BB">$_REQUEST&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$k</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">$v</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$k</span><span style="color: #007700">)&nbsp;&gt;&nbsp;</span><span style="color: #0000BB">0&nbsp;</span><span style="color: #007700">&amp;&amp;&nbsp;</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #DD0000">'/^(FLAG|MY_|TEST_|GLOBALS)/i'</span><span style="color: #007700">,</span><span style="color: #0000BB">$k</span><span style="color: #007700">)&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color: #DD0000">'Shame&nbsp;on&nbsp;you'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;foreach(Array(</span><span style="color: #DD0000">'_GET'</span><span style="color: #007700">,</span><span style="color: #DD0000">'_POST'</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$request</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($</span><span style="color: #0000BB">$request&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$k&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$v</span><span style="color: #007700">)&nbsp;${</span><span style="color: #0000BB">$k</span><span style="color: #007700">}&nbsp;=&nbsp;</span><span style="color: #0000BB">str_replace</span><span style="color: #007700">(</span><span style="color: #0000BB">str_split</span><span style="color: #007700">(</span><span style="color: #DD0000">"[]{}=.'\""</span><span style="color: #007700">),&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$v</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$token</span><span style="color: #007700">)&nbsp;==&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&nbsp;</span><span style="color: #0000BB">highlight_file</span><span style="color: #007700">(</span><span style="color: #0000BB">__FILE__</span><span style="color: #007700">)&nbsp;and&nbsp;exit();<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #DD0000">'/^[a-f0-9-]{36}$/'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$token</span><span style="color: #007700">))&nbsp;die(</span><span style="color: #DD0000">'Shame&nbsp;on&nbsp;you'</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$guess&nbsp;</span><span style="color: #007700">=&nbsp;(int)</span><span style="color: #0000BB">$guess</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$guess&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&nbsp;die(</span><span style="color: #DD0000">'Shame&nbsp;on&nbsp;you'</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Check&nbsp;team&nbsp;token<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$status&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">check_team_redis_status</span><span style="color: #007700">(</span><span style="color: #0000BB">$token</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$status&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #DD0000">"Invalid&nbsp;token"</span><span style="color: #007700">)&nbsp;die(</span><span style="color: #DD0000">'Invalid&nbsp;token'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$status</span><span style="color: #007700">)&nbsp;==&nbsp;</span><span style="color: #0000BB">0&nbsp;</span><span style="color: #007700">||&nbsp;</span><span style="color: #0000BB">$status&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #DD0000">'Stopped'</span><span style="color: #007700">)&nbsp;die(</span><span style="color: #DD0000">'Start&nbsp;Redis&nbsp;first'</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Get&nbsp;team&nbsp;redis&nbsp;port<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$port&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">get_team_redis_port</span><span style="color: #007700">(</span><span style="color: #0000BB">$token</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((int)</span><span style="color: #0000BB">$port&nbsp;</span><span style="color: #007700">&lt;&nbsp;</span><span style="color: #0000BB">1024</span><span style="color: #007700">)&nbsp;die(</span><span style="color: #DD0000">'Try&nbsp;again'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Connect,&nbsp;we&nbsp;rename&nbsp;insecure&nbsp;commands<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;rename-command&nbsp;CONFIG&nbsp;""<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;rename-command&nbsp;SCRIPT&nbsp;""<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;rename-command&nbsp;MODULE&nbsp;""<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;rename-command&nbsp;SLAVEOF&nbsp;""<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;rename-command&nbsp;REPLICAOF&nbsp;""<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;rename-command&nbsp;SET&nbsp;$MY_SET_COMMAND<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$redis&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Redis</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$redis</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"127.0.0.1"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$port</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000BB">$redis</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">auth</span><span style="color: #007700">(</span><span style="color: #0000BB">$token</span><span style="color: #007700">))&nbsp;die(</span><span style="color: #DD0000">'Auth&nbsp;fail'</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Check&nbsp;availability<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$redis</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">rawCommand</span><span style="color: #007700">(</span><span style="color: #0000BB">$MY_SET_COMMAND</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$TEST_KEY</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$TEST_VALUE</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$redis</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">get</span><span style="color: #007700">(</span><span style="color: #0000BB">$TEST_KEY</span><span style="color: #007700">)&nbsp;!==&nbsp;</span><span style="color: #0000BB">$TEST_VALUE</span><span style="color: #007700">)&nbsp;die(</span><span style="color: #DD0000">'Something&nbsp;Wrong?'</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Lottery!<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$LUA_LOTTERY&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"math.randomseed(ARGV[1])&nbsp;for&nbsp;i=0,&nbsp;ARGV[2]&nbsp;do&nbsp;math.random()&nbsp;end&nbsp;return&nbsp;math.random(2^31-1)"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$seed&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">random_int</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0xffffffff&nbsp;</span><span style="color: #007700">/&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$count&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">random_int</span><span style="color: #007700">(</span><span style="color: #0000BB">5</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">10</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$redis</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">eval</span><span style="color: #007700">(</span><span style="color: #0000BB">$LUA_LOTTERY</span><span style="color: #007700">,&nbsp;array(</span><span style="color: #0000BB">$seed</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$count</span><span style="color: #007700">));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">sleep</span><span style="color: #007700">(</span><span style="color: #0000BB">3</span><span style="color: #007700">);&nbsp;</span><span style="color: #FF8000">//&nbsp;Slow&nbsp;down...<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;((int)</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">$guess</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die(</span><span style="color: #DD0000">"Congratulations,&nbsp;the&nbsp;flag&nbsp;is&nbsp;</span><span style="color: #0000BB">$FLAG</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;die(</span><span style="color: #DD0000">":("</span><span style="color: #007700">);<br /></span>
</span>
</code>